[{"id":"9f333e4781e4638f","type":"mqtt out","z":"adcae456bdd7867d","name":"Out to mqtt","topic":"","qos":"1","retain":"false","respTopic":"res/matest","contentType":"","userProps":"","correl":"","expiry":"","broker":"","x":2410,"y":1100,"wires":[]},{"id":"3c78dca59a68d85e","type":"complete","z":"adcae456bdd7867d","name":"","scope":["9f333e4781e4638f"],"uncaught":false,"x":1130,"y":1160,"wires":[["5b9ab6277da65232","c95a3f1b2eb25a1c"]]},{"id":"5b9ab6277da65232","type":"debug","z":"adcae456bdd7867d","name":"debug 143","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1330,"y":1160,"wires":[]},{"id":"2765668aac9e7363","type":"delay","z":"adcae456bdd7867d","name":"","pauseType":"delayv","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":1520,"y":1200,"wires":[["d1864c57b57aa938"]]},{"id":"c95a3f1b2eb25a1c","type":"function","z":"adcae456bdd7867d","name":"Prepare Data","func":"let delay = flow.get('mqtt_timeout_ms');\nif(delay != null){\n    msg.delay = delay;\n}\nlet pending = flow.get('messages_pending');\nif(pending != null){\n    if (pending.includes(msg._msgid)){\n        pending = pending.filter(id => id !== msg._msgid);\n        flow.set('messages_pending', pending);\n        return;\n    }else{\n        pending.push(msg._msgid);\n        flow.set('messages_pending', pending);\n        return msg;\n    }\n}\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":1350,"y":1200,"wires":[["2765668aac9e7363","89b679d717490959"]]},{"id":"d1864c57b57aa938","type":"function","z":"adcae456bdd7867d","name":"If Message is still pending send to backlog","func":"let beFrom = msg.beFrom || false;\nlet filename = flow.get(\"log\");\nlet pending = flow.get('messages_pending');\nif(pending.includes(msg._msgid)){\n    if (!beFrom) {\n        pending = pending.filter(id => id !== msg._msgid);\n        flow.set('messages_pending', pending);\n        msg.filename = filename;\n        return [msg, null];\n    }\n}\nelse{\n    if (beFrom == \"local\"){\n        msg.payload = \"sed '1d' \" + filename + \" -i\";\n        return [null, msg];\n    }\n}","outputs":2,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":1760,"y":1200,"wires":[["ef7330672065f199"],["19b6727a1451005e"]],"outputLabels":["to Local","delete Line"]},{"id":"d7f6af8449bac2ec","type":"inject","z":"adcae456bdd7867d","name":"Set MQTT Timeout + Init pending","props":[{"p":"payload"}],"repeat":"","crontab":"","once":true,"onceDelay":0.1,"topic":"","payload":"1000","payloadType":"num","x":1000,"y":1060,"wires":[["a4c961fbe8334fcc"]]},{"id":"a4c961fbe8334fcc","type":"change","z":"adcae456bdd7867d","name":"set","rules":[{"t":"set","p":"mqtt_timeout_ms","pt":"flow","to":"payload","tot":"msg"},{"t":"set","p":"messages_pending","pt":"flow","to":"[]","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":1210,"y":1060,"wires":[[]]},{"id":"ef7330672065f199","type":"file","z":"adcae456bdd7867d","name":"","filename":"filename","filenameType":"msg","appendNewline":true,"createDir":true,"overwriteFile":"false","encoding":"none","x":2020,"y":1160,"wires":[["e8b732327e789b56"]]},{"id":"e491a035f69508fd","type":"function","z":"adcae456bdd7867d","name":"get path","func":"let path = flow.get(\"log\");\nmsg.payload = \"head -1 \" + path;\nreturn msg;\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":880,"y":1380,"wires":[["489450319257af2b"]]},{"id":"489450319257af2b","type":"exec","z":"adcae456bdd7867d","command":"","addpay":"payload","append":"","useSpawn":"false","timer":"","winHide":false,"oldrc":false,"name":"Read first line from backlogs","x":1080,"y":1380,"wires":[["355263fc5ffc47a3"],["da716d758169e1fe"],["da716d758169e1fe"]]},{"id":"355263fc5ffc47a3","type":"switch","z":"adcae456bdd7867d","name":"If backlogged packet","property":"payload","propertyType":"msg","rules":[{"t":"neq","v":"","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":1080,"y":1320,"wires":[["7b617d2b744b0957"]]},{"id":"7b617d2b744b0957","type":"json","z":"adcae456bdd7867d","name":"Extract Failed line","property":"payload","action":"","pretty":true,"x":1110,"y":1280,"wires":[["7bd3790b5e22207f"]]},{"id":"7bd3790b5e22207f","type":"change","z":"adcae456bdd7867d","name":"Tag data from Local","rules":[{"t":"set","p":"beFrom","pt":"msg","to":"local","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1150,"y":1240,"wires":[["c95a3f1b2eb25a1c"]]},{"id":"3bc3e93847bf5aa0","type":"debug","z":"adcae456bdd7867d","name":"debug 139","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2330,"y":1220,"wires":[]},{"id":"19b6727a1451005e","type":"exec","z":"adcae456bdd7867d","command":"","addpay":"payload","append":"","useSpawn":"false","timer":"","winHide":false,"oldrc":false,"name":"Remove first line from backlogs","x":2090,"y":1240,"wires":[["3bc3e93847bf5aa0"],["70185d7d70792d2c"],["70185d7d70792d2c"]]},{"id":"70185d7d70792d2c","type":"debug","z":"adcae456bdd7867d","name":"debug 140","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":2330,"y":1260,"wires":[]},{"id":"3f22a974a0c0745b","type":"inject","z":"adcae456bdd7867d","name":"Set LogFile","props":[{"p":"payload"}],"repeat":"","crontab":"","once":true,"onceDelay":0.1,"topic":"","payload":"/home/ncdio/.node-red/backlog/backlog.log","payloadType":"str","x":930,"y":1100,"wires":[["d2c916770e09351b"]]},{"id":"d2c916770e09351b","type":"change","z":"adcae456bdd7867d","name":"set","rules":[{"t":"set","p":"log","pt":"flow","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1070,"y":1100,"wires":[[]]},{"id":"e8b732327e789b56","type":"function","z":"adcae456bdd7867d","name":"clear buff mqtt","func":"let delay = 100;\nmsg = {};\nsetTimeout(() => {\n    msg.action = \"connect\";\n    msg.force;\n    node.send(msg);\n}, delay);\nmsg.force;\nmsg.action = \"disconnect\";\nreturn msg;\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2180,"y":1160,"wires":[["f105eeee503088d6"]]},{"id":"781c9ea0e345d6ae","type":"inject","z":"adcae456bdd7867d","name":"","props":[],"repeat":"10","crontab":"","once":true,"onceDelay":0.1,"topic":"","x":785,"y":1380,"wires":[["e491a035f69508fd"]],"l":false},{"id":"da716d758169e1fe","type":"debug","z":"adcae456bdd7867d","name":"debug 145","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":1290,"y":1380,"wires":[]},{"id":"b4b057e0134e180b","type":"switch","z":"adcae456bdd7867d","name":"ncd-filter-sensor-data","property":"topic","propertyType":"msg","rules":[{"t":"eq","v":"sensor_data","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":920,"y":1200,"wires":[["c95a3f1b2eb25a1c"]]},{"id":"89b679d717490959","type":"junction","z":"adcae456bdd7867d","x":1460,"y":1100,"wires":[["f105eeee503088d6"]]},{"id":"f105eeee503088d6","type":"junction","z":"adcae456bdd7867d","x":2300,"y":1100,"wires":[["9f333e4781e4638f"]]},{"id":"166446b35163befc","type":"junction","z":"adcae456bdd7867d","x":780,"y":1200,"wires":[["b4b057e0134e180b"]]}]
